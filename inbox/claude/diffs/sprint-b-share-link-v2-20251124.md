# Sprint B - Share Link v2 Diff Summary
## Date: November 24, 2025

---

## js/app-firebase.js

### ADDED: Share Snapshot API (lines ~105-195)

```javascript
// ============================================
// SHARE SNAPSHOTS (SPRINT B)
// Collection: "shares"
// ============================================

/**
 * Save a share snapshot to Firestore
 * @param {string} designKey - Current design's storage key (may be null)
 * @param {Object} payload - Share payload with design state
 * @returns {Promise<string>} The generated shareId
 */
async saveShareSnapshot(designKey, payload) {
    // Build share document with: designKey, templateKey, formData, 
    // uploadedImages, projectName, creativeDirection, createdAt, version
    // Uses Firestore auto-generated ID via db.collection('shares').add()
    // Returns the document ID as shareId
}

/**
 * Load a share snapshot from Firestore
 * @param {string} shareId - The share document ID
 * @returns {Promise<Object|null>} Share data or null if not found
 */
async loadShareSnapshot(shareId) {
    // Retrieves document from 'shares' collection
    // Returns normalized object: { templateKey, formData, uploadedImages, 
    //   designKey, projectName, creativeDirection, createdAt, version }
}
```

---

## js/app-share-link.js

### MODIFIED: copyShareableLink() 
**Before:** Built base64-encoded URL with all data inline
**After:** Saves to Firestore, uses short ID in URL

```diff
- const base64Data = safeBase64Encode(jsonString);
- const shareableUrl = `${baseUrl}#design=${base64Data}`;
+ const shareId = await EmailBriefingDB.saveShareSnapshot(designKey, payload);
+ const shareableUrl = `${baseUrl}#share=${shareId}`;
```

### MODIFIED: loadFromUrlHash()
**Before:** Only handled `#design=` base64 format
**After:** Detects and routes to appropriate handler

```diff
+ if (hash.includes('#share=')) {
+     return await loadFromShortShareId(hash);
+ } else if (hash.includes('#design=')) {
+     return await loadFromLegacyBase64(hash);
+ }
```

### ADDED: loadFromShortShareId(hash)
- Extracts shareId from URL
- Calls EmailBriefingDB.loadShareSnapshot()
- Validates template exists
- Calls applyShareLinkData()

### ADDED: loadFromLegacyBase64(hash)  
- Refactored from old loadFromUrlHash()
- Decodes base64, parses JSON
- Converts to unified format
- Calls applyShareLinkData()

### ADDED: applyShareLinkData({ templateKey, formData, ... })
- Unified entry point for both schemes
- Sets tracking variables
- Shows builder screen
- Calls applyLoadedProject() (Load Pipeline v2)
- Updates UI elements

### ADDED: navigateToSafeScreen()
- Clears URL hash
- Shows home screen
- Used for error recovery

### MODIFIED: Version comment
```diff
- * Version: 2.0 - Load Pipeline v2 Integration
+ * Version: 3.0 - Short Share IDs (Sprint B)
```

---

## Firestore Collection Schema

### New Collection: `shares`

| Field | Type | Description |
|-------|------|-------------|
| designKey | string\|null | Source design storage key |
| templateKey | string | Template identifier |
| formData | object | Form field key-value pairs |
| uploadedImages | object | Image slot â†’ URL mapping |
| projectName | string | Display name |
| creativeDirection | string | Dropdown value |
| createdAt | number | Unix timestamp |
| version | string | Schema version ("2.0") |

Document IDs are auto-generated by Firestore (~20 chars).
